#!/usr/bin/env ruby
#
# = synth
#
# Synthesizes the blog. Runs Uglify to compile and minify JavaScripts,
# then runs Sass to compile stylesheets, and finally runs Jekyll to
# compile the Markdown-formatted posts with the static HTML.
#
# Please run this in the root directory of the psychedeli.ca installation.
#
# Author:: Tom Scott
# Homepage:: http://psychedeli.ca/

require 'pathname'

ENV['BUNDLE_GEMFILE'] ||= File.expand_path("../../Gemfile", Pathname.new(__FILE__).realpath)

require 'rubygems'
require 'bundler/setup'

require 'thor'
require 'yaml'
require 'jekyll'
require 'uglifier'
require 'sass'
require 'fileutils'

class Synth < Thor
	include Thor::Actions

	desc "javascripts", "Compiles and minifies all .js files located in js/ with Uglify."
	def javascripts
		javascripts = ""

		say "[uglifier] Compiling JavaScripts..."
		Dir.glob(File.join(Dir.pwd, 'app', 'js', '*.js')) do |js_file|
      unless js_file == 'application.js'
			   javascripts += Uglifier.compile(File.join(Dir.pwd, 'js', js_file))
      end
		end
		say "[uglifier] ..done"

		say "Building master JavaScript..."
		File.read(File.join(Dir.pwd, 'app', 'js', 'application.js')) do |f|
			f.write(javascripts)
		end
		say "[uglifier] ..done"
	end

	desc "stylesheets", "Compile and compress stylesheets in css/ with Sass."
	def stylesheets
		stylesheets = ""

		say "[sass] Compiling Sass stylesheets..."
		Dir.glob(File.join(Dir.pwd, 'app', 'css', '*.scss')) do |css_file|
			stylesheets += Sass.compile_file(File.join(Dir.pwd, 'css', css_file))
		end
		say "[sass] ..done"

		say "[sass] Building master stylesheet..."
		File.read(File.join(Dir.pwd, 'app', 'css', 'screen.css')) do |f|
			f.write(stylesheets)
		end
		say "[sass] ..done"
	end

	desc "content", 	"Generates the post and layout content with Jekyll."
	def content
    say "[jekyll] Compiling static content..."
    run "bundle exec jekyll --config cfg/jekyll.yml"
  end

	desc "all", "Generates the entire site."
	def all
		invoke :javascripts
		invoke :stylesheets
		invoke :content
	end
end

Synth.start

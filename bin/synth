#!/usr/bin/env ruby
#
# = synth
#
# Synthesizes the blog. Runs Uglify to compile and minify JavaScripts,
# then runs Sass to compile stylesheets, and finally runs Jekyll to
# generate the static HTML from Markdown-formatted posts.
#
# Author:: Tom Scott
# Homepage:: http://psychedeli.ca/

require 'pathname'

ENV['BUNDLE_GEMFILE'] ||= File.expand_path("../../Gemfile", Pathname.new(__FILE__).realpath)

require 'rubygems'
require 'bundler/setup'

require 'thor'
require 'yaml'
require 'jekyll'
require 'uglifier'
require 'sass'
require 'fileutils'

class Synth < Thor
	include Thor::Actions

	desc "javascripts", "Compiles and minifies all .js files located in js/ with Uglify."
	def javascripts
		javascripts = ""

		say "[uglifier] Compiling JavaScripts..."
		Dir.glob(File.join(File.expand_path('./app/js/'), '*.js')) do |js_file|
      unless js_file == 'application.js'
			   javascripts += Uglifier.compile(File.join(Dir.pwd, 'js', js_file))
      end
		end
		say "[uglifier] ..done"

		say "Building master JavaScript..."
		File.read(File.expand_path('./app/js/application.js')) do |f|
			f.write(javascripts)
		end
		say "[uglifier] ..done"
	end

	desc "stylesheets", "Compile and compress stylesheets in css/ with Sass."
	def stylesheets
		stylesheets = ""

		say "[sass] Compiling Sass stylesheets..."
		Dir.glob(File.join(File.expand_path('./app/css'), '*.scss')) do |css_file|
			stylesheets += Sass.compile_file(css_file)
		end
		say "[sass] ..done"

		say "[sass] Building master stylesheet..."
		File.read(File.expand_path('./app/css/screen.css')) do |f|
			f.write(stylesheets)
		end
		say "[sass] ..done"
	end

	desc "content", 	"Generates the post and layout content with Jekyll."
	def content
    say "[jekyll] Compiling static content..."
    run "bundle exec jekyll --config cfg/jekyll.yml"
  end

	desc "all", "Generates the entire site."
	method_option :clobber
	def all
		invoke :destroy if options[:clobber]
		invoke :javascripts
		invoke :stylesheets
		invoke :content
	end

	desc "destroy", "Destroys all generated static content"
	def destroy
		run "rm -rf pub/*"
		say "All data in pub/ has been deleted."
	end

	default_task :all
end

Synth.start
